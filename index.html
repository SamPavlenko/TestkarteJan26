<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Bürgerbeteiligung Baesweiler</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>

body {
  margin: 0;
}

#map {
  height: 100vh;
}

#formBox {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 1000;
  background: white;
  padding: 12px;
  border-radius: 8px;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
  font-size: 14px;
  width: 250px;
}

#saveBtn {
  margin-top: 8px;
  width: 100%;
  padding: 8px;
  font-size: 14px;
  cursor: pointer;
}

</style>
</head>

<body>

<div id="formBox">

<b>Meldung eintragen</b>
<br><br>

Kategorie:
<br>
<select id="category" style="width:100%">
  <option value="Hitze">Hitze</option>
  <option value="Starkregen">Starkregen</option>
  <option value="Hochwasser">Hochwasser</option>
  <option value="Versiegelung">Versiegelung</option>
  <option value="Weiteres">Weiteres</option>
</select>

<br><br>

Beschreibung:
<br>
<textarea id="comment" rows="3" style="width:100%"
placeholder="Beschreibung eingeben..."></textarea>

<br>

<button id="saveBtn" disabled>Eintrag speichern</button>

<p id="hint">
Klicke zuerst auf die Karte.
</p>

</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>

// ================== FIREBASE ==================
  
const firebaseConfig = {
  apiKey: "AIzaSyDQ_c0k7ISbheCf2ineoBLvvRaaSOzEJSw",
  authDomain: "testkarte-jan26.firebaseapp.com",
  projectId: "testkarte-jan26",
  storageBucket: "testkarte-jan26.firebasestorage.app",
  messagingSenderId: "481455551535",
  appId: "1:481455551535:web:385cb5bdd8c82af03902da"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();


// ================== PARAMETER ==================

const centerLat = 50.908;
const centerLng = 6.187;

const maxDistance = 10000; // 10km

let tempMarker = null;
let selectedLatLng = null;

// ================== MAP ==================

const map = L.map('map').setView([centerLat, centerLng], 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// ================== VISUAL RADIUS MASK ==================

const radiusCircle = L.circle([centerLat, centerLng], {
  radius: maxDistance,
  color: "black",
  weight: 2,
  fillOpacity: 0
}).addTo(map);


// World mask with hole
const outerBounds = [
  [-90, -180],
  [-90, 180],
  [90, 180],
  [90, -180]
];

const innerCircle = [];

const points = 120;

for (let i = 0; i < points; i++) {

  const angle = (i / points) * Math.PI * 2;

  const lat = centerLat + (maxDistance / 111320) * Math.cos(angle);
  const lng = centerLng + (maxDistance / (111320 * Math.cos(centerLat * Math.PI / 180))) * Math.sin(angle);

  innerCircle.push([lat, lng]);
}

// Create mask
L.polygon([outerBounds, innerCircle], {

  color: null,
  fillColor: "black",
  fillOpacity: 0.35,
  stroke: false

}).addTo(map);
  
// ================== DISTANCE ==================

function distanceInMeters(lat1, lon1, lat2, lon2) {

  const R = 6371000;

  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c;
}

// ================== COLORS ==================

function getColor(category) {

  if (category === "Hitze") return "orange";
  if (category === "Starkregen") return "blue";
  if (category === "Hochwasser") return "brown";
  if (category === "Versiegelung") return "gray";
  if (category === "Weiteres") return "green";

  return "black";
}

// ================== DRAW MARKER ==================

function drawMarker(lat, lng, category, comment) {

  const popupText =
    "<b>Kategorie:</b> " + category +
    "<br><b>Info:</b> " + comment;

  const color = getColor(category);

  L.circleMarker([lat, lng], {
    radius: 8,
    fillColor: color,
    color: "#000",
    weight: 1,
    fillOpacity: 0.8
  })
  .addTo(map)
  .bindPopup(popupText);
}

// ================== MAP CLICK ==================

map.on('click', function(e) {

  const lat = e.latlng.lat;
  const lng = e.latlng.lng;

  const dist = distanceInMeters(centerLat, centerLng, lat, lng);

  if (dist > maxDistance) {
    alert("Marker nur im Umkreis von 30 km um Baesweiler erlaubt.");
    return;
  }

  selectedLatLng = e.latlng;

  if (tempMarker) {
    map.removeLayer(tempMarker);
  }

  tempMarker = L.marker([lat, lng]).addTo(map);

  document.getElementById("saveBtn").disabled = false;
  document.getElementById("hint").innerText = "Jetzt Kategorie auswählen und speichern.";

});

// ================== SAVE BUTTON ==================

document.getElementById("saveBtn").addEventListener("click", function() {

  if (!selectedLatLng) return;

  const category = document.getElementById("category").value;
  const comment = document.getElementById("comment").value;

  const lat = selectedLatLng.lat;
  const lng = selectedLatLng.lng;

  db.collection("marker").add({

    lat: lat,
    lng: lng,
    category: category,
    comment: comment,
    timestamp: new Date()

  });

  if (tempMarker) {
    map.removeLayer(tempMarker);
  }

  drawMarker(lat, lng, category, comment);

  selectedLatLng = null;
  tempMarker = null;

  document.getElementById("comment").value = "";
  document.getElementById("saveBtn").disabled = true;
  document.getElementById("hint").innerText = "Klicke auf die Karte für neuen Punkt.";

});

// ================== LOAD EXISTING ==================

db.collection("marker").get().then(snapshot => {

  snapshot.forEach(doc => {

    const data = doc.data();

    drawMarker(
      data.lat,
      data.lng,
      data.category,
      data.comment
    );

  });

});

</script>

</body>
</html>
